{% extends "base.html" %}
{% block title %}æœ€è¿‘ç€è¦½{% endblock %}

{% block content %}
<style>
    /* RWD Grid è¨­å®š */
    .grid-container {
        display: grid;
        gap: 20px; /* å¡ç‰‡é–“è· */
        padding: 10px 0;
        /* é è¨­æ‰‹æ©Ÿç‰ˆï¼š1 åˆ— */
        grid-template-columns: repeat(1, 1fr);
    }

    /* å¹³æ¿/ä¸­è¢å¹•ï¼š3 åˆ— */
    @media (min-width: 768px) {
        .grid-container {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    /* æ¡Œæ©Ÿ/å¤§è¢å¹•ï¼š5 åˆ— */
    @media (min-width: 1200px) {
        .grid-container {
            grid-template-columns: repeat(5, 1fr);
        }
    }
</style>

    <h2 class="my-3">æœ€è¿‘ç€è¦½</h2>

    {% if last_week_pdfs %}
        <h4 class="mt-4">ğŸ“… ä¸ƒå¤©å…§é–‹å•Ÿ</h4>
        <div class="section-recent grid-container">
            {% for pdf in last_week_pdfs %}
                 {% include "card.html" %}
            {% endfor %}
        </div>
    {% endif %}

    {% if last_month_pdfs %}
        <h4 class="mt-4">ğŸ—“ï¸ ä¸€å€‹æœˆå…§é–‹å•Ÿ</h4>
        <div class="section-overview grid-container">
            {% for pdf in last_month_pdfs %}
                {# ä¿®æ­£ï¼šçµ±ä¸€ä½¿ç”¨ include card.htmlï¼Œç¢ºä¿æ¨£å¼ä¸€è‡´ä¸”åŒ…å«åŠŸèƒ½é¸å–® #}
                {% include "card.html" %}
            {% endfor %}
        </div>
    {% endif %}

    {% if not last_week_pdfs and not last_month_pdfs %}
        <p>ç›®å‰æ²’æœ‰æœ€è¿‘é–‹å•Ÿçš„æ–‡ä»¶ã€‚</p>
    {% endif %}

    <div id="rename-modal" class="modal">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="rename-title">
            <h3 id="rename-title">é‡æ–°å‘½å</h3>
            <input type="text" id="rename-input" aria-label="æ–°æª”æ¡ˆåç¨±">
            <div class="modal-actions">
                <button id="rename-confirm">ç¢ºå®š</button>
                <button id="rename-cancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="modal">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="delete-title">
            <h3 id="delete-title">ç¢ºèªåˆªé™¤</h3>
            <p>ç¢ºå®šè¦åˆªé™¤é€™å€‹æª”æ¡ˆå—ï¼Ÿ</p>
            <div class="modal-actions">
                <button id="delete-confirm">åˆªé™¤</button>
                <button id="delete-cancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const csrftoken = '{{ csrf_token }}';
            let currentRenameId = null;
            let currentDeleteId = null;

            // åˆ‡æ›å¡ç‰‡å…§çš„é¸å–® (ä½¿ç”¨ Event Delegation ç¢ºä¿å‹•æ…‹è¼‰å…¥ä¹Ÿèƒ½é‹ä½œ)
            document.body.addEventListener('click', e => {
                if (e.target.classList.contains('menu-btn')) {
                    e.stopPropagation();
                    const menu = e.target.closest('.caption').querySelector('.menu');
                    // é—œé–‰å…¶ä»–å·²é–‹å•Ÿçš„ menu
                    document.querySelectorAll('.card .menu').forEach(m => {
                        if (m !== menu) m.style.display = 'none';
                    });
                    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
                } else {
                    // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰æ‰€æœ‰ menu
                    if (!e.target.closest('.menu')) {
                        closeAllMenus();
                    }
                }
            });

            // é»æ“Šé‡æ–°å‘½å
            document.querySelectorAll('.rename-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    currentRenameId = e.target.closest('.card').dataset.id;
                    const filename = e.target.closest('.card').querySelector('.filename').textContent.trim();
                    document.getElementById('rename-input').value = filename;
                    document.getElementById('rename-modal').style.display = 'flex';
                    closeAllMenus();
                });
            });

            // å–æ¶ˆé‡æ–°å‘½å
            document.getElementById('rename-cancel').addEventListener('click', () => {
                document.getElementById('rename-modal').style.display = 'none';
            });

            // ç¢ºèªé‡æ–°å‘½å
            document.getElementById('rename-confirm').addEventListener('click', () => {
                const newName = document.getElementById('rename-input').value.trim();
                if (!newName) return alert('åç¨±ä¸å¯ç©ºç™½');

                fetch("{% url 'rename_pdf' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `id=${currentRenameId}&name=${encodeURIComponent(newName)}`
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const filenameSpan = document.querySelector(`.card[data-id="${currentRenameId}"] .filename`);
                            if(filenameSpan) filenameSpan.textContent = data.new_name;
                            document.getElementById('rename-modal').style.display = 'none';
                        } else {
                            alert('é‡æ–°å‘½åå¤±æ•—');
                        }
                    })
                    .catch(() => alert('è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'));
            });

            // é»æ“Šåˆªé™¤
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    currentDeleteId = e.target.closest('.card').dataset.id;
                    document.getElementById('delete-modal').style.display = 'flex';
                    closeAllMenus();
                });
            });

            // å–æ¶ˆåˆªé™¤
            document.getElementById('delete-cancel').addEventListener('click', () => {
                document.getElementById('delete-modal').style.display = 'none';
            });

            // ç¢ºèªåˆªé™¤
            document.getElementById('delete-confirm').addEventListener('click', () => {
                fetch("{% url 'delete_pdf' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `id=${currentDeleteId}`
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const card = document.querySelector(`.card[data-id="${currentDeleteId}"]`);
                            if (card) card.remove();
                            document.getElementById('delete-modal').style.display = 'none';
                        } else {
                            alert('åˆªé™¤å¤±æ•—');
                        }
                    })
                    .catch(() => alert('è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'));
            });

            // é»æ“Š modal èƒŒæ™¯å€åŸŸæ™‚é—œé–‰
            window.addEventListener('click', e => {
                const renameModal = document.getElementById('rename-modal');
                const deleteModal = document.getElementById('delete-modal');
                if (e.target === renameModal) renameModal.style.display = 'none';
                if (e.target === deleteModal) deleteModal.style.display = 'none';
            });

            function closeAllMenus() {
                document.querySelectorAll('.card .menu').forEach(m => m.style.display = 'none');
            }
        });
    </script>
{% endblock %}